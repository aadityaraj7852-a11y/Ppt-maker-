<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>MCQ → PPTX (Perfect Preview → PPT Matching + Kalam Fix)</title>

<link href="https://fonts.googleapis.com/css2?family=Kalam&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.bundle.min.js"></script>

<style>
body{font-family:'Kalam',cursive;background:#0f1720;color:#eee;margin:16px}
.card{background:#121926;padding:16px;border-radius:10px;border:1px solid #223;max-width:1150px;margin:auto}
label{color:#9fb7ff;font-weight:700;margin-top:8px;display:block}
textarea,input{width:100%;padding:8px;border-radius:6px;border:1px solid #334;background:#0b1220;color:#fff;font-family:'Kalam',cursive}
.btn{padding:8px 12px;border:none;border-radius:8px;margin-top:10px;cursor:pointer;font-family:'Kalam',cursive;font-weight:700}
.btn-blue{background:#0b74ff;color:#fff}
.btn-grey{background:#333;color:#ccd}
.btn-red{background:#e11d48;color:#fff}

.preview{background:#071019;border:1px solid #203040;margin-top:10px;
         border-radius:8px;padding:12px;max-height:520px;overflow:auto}
.slide-box{background:#000;color:#fff;padding:8px;border-radius:6px;margin-bottom:10px}
.slide-block{white-space:pre-line;font-size:18px;line-height:1.2}
.slide-block[contenteditable="true"]{outline:1px dashed #666;padding:6px;border-radius:4px}

.row{display:flex;gap:14px;flex-wrap:wrap}
.col{flex:1;min-width:300px}
</style>
</head>

<body>
<div class="card">

<h2 style="color:#fff">MCQ → PPTX (FINAL FIXED VERSION)</h2>

<div class="row">

<!-- LEFT -->
<div class="col">
<label>JSON Input</label>
<textarea id="jsonData" rows="8"></textarea>

<h3 style="color:#fff;margin-top:10px">Manual Entry</h3>

<label>Question</label>
<textarea id="qInput" rows="2"></textarea>

<label>Options</label>
<input id="o1" placeholder="Option 1">
<input id="o2" placeholder="Option 2">
<input id="o3" placeholder="Option 3">
<input id="o4" placeholder="Option 4">

<button class="btn btn-grey" id="addBtn">Add Question</button>

<label style="margin-top:10px">Background Image</label>
<input type="file" id="bgImg" accept="image/*">

<div class="row">
  <div class="col"><label>Slide Width</label><input id="wPx" value="1280"></div>
  <div class="col"><label>Slide Height</label><input id="hPx" value="720"></div>
</div>

<div class="row">
  <div class="col"><label>Top Margin</label><input id="topM" value="130"></div>
  <div class="col"><label>Left Margin</label><input id="leftM" value="50"></div>
</div>

<div class="row">
  <div class="col"><label>Right Margin</label><input id="rightM" value="50"></div>
  <div class="col"><label>Bottom Margin</label><input id="bottomM" value="100"></div>
</div>

<div class="row">
  <div class="col"><label>Question Color</label><input type="color" id="qColor" value="#ffff00"></div>
  <div class="col"><label>Option Color</label><input type="color" id="oColor" value="#ffffff"></div>
</div>

<button id="importBtn" class="btn btn-grey">Import JSON</button>
<button id="makeBtn" class="btn btn-blue">Generate PPTX</button>
<button id="clrBtn" class="btn btn-red">Clear</button>

</div>

<!-- RIGHT -->
<div class="col">
<label>Preview (editable)</label>
<div id="preview" class="preview"><div style="color:#7aa">Preview दिखाई देगा…</div></div>
</div>

</div>
</div>


<script>

const $ = id => document.getElementById(id);
let DATA = [];
let BG = null;

/* NEW NORMALIZER — no trims, no loss */
function normalize(item){
 return {
   question:(item.question||"")
       .replace(/\\n/g,"\n")
       .replace(/\/n/g,"\n"),
   option:(item.option||["","","",""])
       .slice(0,4)
       .map(o=>o.replace(/\\n/g,"\n").replace(/\/n/g,"\n"))
 };
}

/* PREVIEW PARSE — no split loss */
function parseBlock(t){
 let lines=t.split("\n");
 let q = lines[0].replace(/^[Qq]\d+\.\s*/,"");
 let opts=[];
 for(let i=1;i<lines.length && opts.length<4;i++){
   opts.push(lines[i].replace(/^\d+\.\s*/,""));
 }
 while(opts.length<4) opts.push("");
 return normalize({question:q,option:opts});
}

/* Render preview */
function render(){
 let box=$("preview");
 box.innerHTML="";
 if(!DATA.length){
   box.innerHTML="<div style='color:#7aa'>No Questions</div>";
   return;
 }

 DATA.forEach((q,i)=>{
   let wrap=document.createElement("div");
   wrap.className="slide-box";

   let blk=document.createElement("div");
   blk.className="slide-block";
   blk.contentEditable="true";

   blk.innerText =
     `Q${i+1}. ${q.question}\n`+
     `1. ${q.option[0]}\n`+
     `2. ${q.option[1]}\n`+
     `3. ${q.option[2]}\n`+
     `4. ${q.option[3]}`;

   blk.onblur=()=>{
     DATA[i]=parseBlock(blk.innerText);
     render();
   };

   wrap.appendChild(blk);
   box.appendChild(wrap);
 });
}

/* Import JSON */
$("importBtn").onclick=()=>{
 try{
   let j=JSON.parse($("jsonData").value);
   if(!Array.isArray(j)) j=[j];
   DATA=j.map(normalize);
   render();
 }catch(e){alert("Invalid JSON");}
};

/* Add manually */
$("addBtn").onclick=()=>{
 if(!$("qInput").value.trim()) return alert("Question empty");

 DATA.push(normalize({
   question:$("qInput").value,
   option:[$("o1").value,$("o2").value,$("o3").value,$("o4").value]
 }));

 $("qInput").value=$("o1").value=$("o2").value=$("o3").value=$("o4").value="";
 render();
};

/* BG Upload */
$("bgImg").onchange=e=>{
 let f=e.target.files[0];
 if(!f)return;
 let r=new FileReader();
 r.onload=()=>BG=r.result;
 r.readAsDataURL(f);
};

/* Sync preview → DATA */
function syncPrev(){
 document.querySelectorAll(".slide-block").forEach((blk,i)=>{
   DATA[i]=parseBlock(blk.innerText);
 });
}

/* WRAP TEXT */
function wrapText(ctx,txt,x,y,maxW,lh,limit){
 if(txt.trim()===""){
   y+=lh;
   return y;
 }
 let words=txt.split(" ");
 let line="";
 for(let w of words){
   let t=line+w+" ";
   if(ctx.measureText(t).width>maxW){
     ctx.fillText(line,x,y);
     y+=lh;
     if(y>=limit) return limit;
     line=w+" ";
   } else line=t;
 }
 ctx.fillText(line,x,y);
 y+=lh;
 return y;
}

/* ⭐ FINAL CANVAS — FULL TEXT EXACT RENDER ⭐ */
async function canvasSlide(fullText,W,H,top,left,right,bottom,qColor,oColor){

 await document.fonts.load("30px Kalam");

 let c=document.createElement("canvas");
 c.width=W; c.height=H;
 let ctx=c.getContext("2d");

 /* BG */
 if(BG){
   let img=new Image();
   img.src=BG;
   await new Promise(r=>img.onload=r);
   ctx.drawImage(img,0,0,W,H);
 } else {
   ctx.fillStyle="#000";
   ctx.fillRect(0,0,W,H);
 }

 let maxW=W-left-right;
 let limit=H-bottom;
 let y=top;

 let lines = fullText.split("\n");

 /* Main font */
 ctx.font=`30px Kalam`;

 for(let ln of lines){

   // QUESTION LINES → yellow
   if(!/^\d+\./.test(ln)) ctx.fillStyle=qColor;
   else ctx.fillStyle=oColor;

   y = wrapText(ctx, ln, left, y, maxW, 34, limit);
   if(y >= limit) break;
 }

 return c.toDataURL("image/png");
}

function pxIn(px){return px/96;}

/* Generate PPT */
$("makeBtn").onclick=async()=>{

 if(!DATA.length) return alert("No questions");

 syncPrev();

 let W=parseInt($("wPx").value);
 let H=parseInt($("hPx").value);
 let top=parseInt($("topM").value);
 let left=parseInt($("leftM").value);
 let right=parseInt($("rightM").value);
 let bottom=parseInt($("bottomM").value);

 let qc=$("qColor").value;
 let oc=$("oColor").value;

 let ppt=new PptxGenJS();
 ppt.defineLayout({name:"CUST",width:pxIn(W),height:pxIn(H)});
 ppt.layout="CUST";

 for(let i=0;i<DATA.length;i++){

   let fullText =
     `Q${i+1}. ${DATA[i].question}\n`+
     `1. ${DATA[i].option[0]}\n`+
     `2. ${DATA[i].option[1]}\n`+
     `3. ${DATA[i].option[2]}\n`+
     `4. ${DATA[i].option[3]}`;

   let img = await canvasSlide(fullText,W,H,top,left,right,bottom,qc,oc);

   let slide=ppt.addSlide();
   slide.addImage({data:img,x:0,y:0,w:pxIn(W),h:pxIn(H)});
 }

 ppt.writeFile({fileName:"MCQ_FINAL_PPTX_FIXED.pptx"});
};

$("clrBtn").onclick=()=>{DATA=[];$("jsonData").value="";render();};

render();

</script>

</body>
</html>
