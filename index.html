<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MCQ → PPTX (Canvas-rendered Kalam, No Gap, Custom Size)</title>

<!-- Kalam Font (Google) -->
<link href="https://fonts.googleapis.com/css2?family=Kalam&display=swap" rel="stylesheet">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- PPTX Generator -->
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.bundle.min.js"></script>

<style>
  body{font-family:'Kalam',cursive;background:#0f1720;color:#eee;margin:16px}
  .wrap{max-width:1100px;margin:auto}
  .card{background:#121926;border-radius:10px;padding:16px;border:1px solid #223}
  label{font-weight:700;color:#9fb7ff;margin-top:6px;display:block}
  textarea,input,select{width:100%;padding:8px;border-radius:6px;border:1px solid #334;background:#0b1220;color:#fff;font-family:'Kalam',cursive}
  .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:6px;font-family:'Kalam',cursive}
  .btn-blue{background:#0b74ff;color:#fff}.btn-grey{background:#333;color:#ccd}.btn-red{background:#e11d48;color:#fff}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1;min-width:320px}
  .preview{background:#071019;padding:12px;border-radius:8px;margin-top:10px;border:1px solid #203040;max-height:520px;overflow:auto;font-family:'Kalam',cursive}
  .slide-preview{background:linear-gradient(180deg,#031018,#001216);padding:8px;border-radius:6px;margin-bottom:10px;color:#fff;line-height:1.02}
  .slide-block{font-size:18px;white-space:pre-line;margin-top:6px}
  .slide-block[contenteditable="true"]{outline:1px dashed rgba(120,140,180,0.14);padding:6px;border-radius:4px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .hint{color:#7aa;font-size:13px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 style="color:#fff">MCQ → PPTX (Canvas → Image → PPTX) — Kalam guaranteed</h2>

    <div class="row">
      <div class="col">
        <label>JSON Input</label>
        <textarea id="jsonArea" rows="8" placeholder='[{"question":"...","option":["..","..","..",".."]}]'></textarea>
        <div class="hint">JSON में \n लिखो तो line break रहेगा।</div>

        <h3 style="color:#fff;margin-top:8px">Manual Entry</h3>
        <label>Question</label>
        <textarea id="manualQ" rows="2"></textarea>
        <label>Options (4)</label>
        <input id="opt1" placeholder="Option 1" />
        <input id="opt2" placeholder="Option 2" />
        <input id="opt3" placeholder="Option 3" />
        <input id="opt4" placeholder="Option 4" />
        <div style="margin-top:8px"><button id="addManual" class="btn btn-grey"><i class="fa fa-plus"></i> Add to List</button></div>

        <label style="margin-top:12px">Background Image (optional)</label>
        <input type="file" id="bgImg" accept="image/*">

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>Slide width (px)</label>
            <input id="slideW" value="1280" />
          </div>
          <div style="flex:1">
            <label>Slide height (px)</label>
            <input id="slideH" value="720" />
          </div>
        </div>

        <label style="margin-top:8px">Top margin (px)</label>
        <input id="topMargin" value="10" />

        <div style="display:flex;gap:8px;margin-top:10px" class="controls">
          <button id="importBtn" class="btn btn-grey"><i class="fa fa-check"></i> Import JSON</button>
          <button id="generateBtn" class="btn btn-blue"><i class="fa fa-file-powerpoint"></i> Generate PPTX</button>
          <button id="clearBtn" class="btn btn-red"><i class="fa fa-trash"></i> Clear</button>
        </div>

        <div class="hint">Preview में edit करके बाहर क्लिक कर दो (blur) — वही updated text PPT बनेगा।</div>
      </div>

      <div class="col">
        <label>Preview (click to edit)</label>
        <div id="preview" class="preview"><div style="color:#7aa">Preview दिखाई देगा यहाँ…</div></div>
        <div class="hint" style="margin-top:8px">अगर PPT पर exact Kalam चाहिए तो generate दबाने पर canvas-image बनकर PPT में आएगा — इसलिए PPT पर हमेशा वही दिखेगा जो preview में है।</div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = [];
let BG_DATAURL = null;

/* wait until Kalam font loaded */
async function ensureFontLoaded() {
  // Wait for document.fonts to be ready; also explicitly load Kalam
  try {
    await document.fonts.load('16px Kalam');
    await document.fonts.ready;
  } catch(e){
    // fallback: still continue
    console.warn('font load error', e);
  }
}

/* helper: convert px to inches (pptx uses inches) assuming 96 DPI */
function pxToIn(px){ return px/96; }

/* read file -> dataURL */
function fileToDataURL(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.readAsDataURL(file);
  });
}

/* normalize incoming item */
function normalizeItem(item){
  const q = (item.question||"").replace(/\\r/g,"").replace(/\\t/g," ").replace(/\\n/g,"\n");
  const opts = (item.option||["","","",""]).slice(0,4).map(o=> (o||"").replace(/\\r/g,"").replace(/\\t/g," ").replace(/\\n/g,"\n"));
  while(opts.length<4) opts.push("");
  return {question:q, option:opts};
}

/* Render preview: editable single block containing Q + options lines */
function renderPreview(){
  const box = $('preview');
  box.innerHTML = '';
  if(DATA.length===0){ box.innerHTML = '<div style="color:#7aa">No questions.</div>'; return; }

  DATA.forEach((q,i)=>{
    const outer = document.createElement('div');
    outer.className = 'slide-preview';

    const block = document.createElement('div');
    block.className = 'slide-block';
    block.contentEditable = 'true';

    const lines = [];
    lines.push(`Q${i+1}. ${q.question}`);
    lines.push(`1. ${q.option[0]}`);
    lines.push(`2. ${q.option[1]}`);
    lines.push(`3. ${q.option[2]}`);
    lines.push(`4. ${q.option[3]}`);
    block.innerText = lines.join('\n');

    block.addEventListener('blur', ()=> {
      // update DATA from edited text
      const parsed = parseBlock(block.innerText);
      DATA[i] = normalizeItem(parsed);
      // re-render to normalize numbering & spacing
      renderPreview();
    });

    outer.appendChild(block);
    box.appendChild(outer);
  });
}

/* parse block text into item */
function parseBlock(text){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter((l,idx)=> !(l==="" && idx===0));
  if(lines.length===0) return {question:"", option:["","","",""]};
  let first = lines[0].replace(/^[Qq]\d+\.\s*/,'');
  const opts = [];
  for(let i=1;i<lines.length && opts.length<4;i++){
    opts.push(lines[i].replace(/^\d+\.\s*/,''));
  }
  while(opts.length<4) opts.push("");
  return {question:first, option:opts};
}

/* import JSON */
$('importBtn').addEventListener('click', ()=>{
  try{
    let j = JSON.parse($('jsonArea').value);
    if(!Array.isArray(j)) j = [j];
    DATA = j.map(normalizeItem);
    renderPreview();
  }catch(e){
    alert("Invalid JSON — सही array डालो।");
  }
});

/* add manual */
$('addManual').addEventListener('click', ()=>{
  const q = $('manualQ').value.trim();
  if(!q){ alert("Question खाली है"); return; }
  const item = {question:q, option:[ $('opt1').value, $('opt2').value, $('opt3').value, $('opt4').value ]};
  DATA.push(normalizeItem(item));
  $('manualQ').value = $('opt1').value = $('opt2').value = $('opt3').value = $('opt4').value = "";
  renderPreview();
});

/* bg image */
$('bgImg').addEventListener('change', async ev=>{
  const f = ev.target.files[0];
  if(!f) return;
  BG_DATAURL = await fileToDataURL(f);
});

/* clear */
$('clearBtn').addEventListener('click', ()=>{
  DATA = [];
  $('jsonArea').value = "";
  renderPreview();
});

/* sync any preview edits before generate */
function syncPreviewToData(){
  const blocks = document.querySelectorAll('.slide-block');
  blocks.forEach((blk, idx)=>{
    const parsed = parseBlock(blk.innerText || "");
    DATA[idx] = normalizeItem(parsed);
  });
}

/* draw single slide to canvas and return dataURL */
async function renderSlideToDataURL(item, pxW, pxH, topMarginPx, bgDataUrl){
  await ensureFontLoaded();

  const cvs = document.createElement('canvas');
  cvs.width = pxW;
  cvs.height = pxH;
  const ctx = cvs.getContext('2d');

  // background
  if(bgDataUrl){
    // draw background image fitting canvas
    const img = await new Promise((res,rej)=>{
      const i = new Image();
      i.crossOrigin = 'anonymous';
      i.onload = ()=>res(i);
      i.onerror = ()=>res(null);
      i.src = bgDataUrl;
    });
    if(img){
      // cover
      const arSrc = img.width/img.height;
      const arDst = pxW/pxH;
      let dx=0,dy=0,dw=pxW,dh=pxH;
      if(arSrc>arDst){
        // source wider -> crop sides
        const newW = img.height * arDst;
        const sx = (img.width - newW)/2;
        ctx.drawImage(img, sx, 0, newW, img.height, 0, 0, pxW, pxH);
      } else {
        // source taller -> crop top/bottom
        const newH = img.width / arDst;
        const sy = (img.height - newH)/2;
        ctx.drawImage(img, 0, sy, img.width, newH, 0, 0, pxW, pxH);
      }
    } else {
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,pxW,pxH);
    }
  } else {
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,pxW,pxH);
  }

  // text style: white, Kalam, compact lines
  ctx.fillStyle = "#ffffff";
  // choose font size relative to canvas height; you can tweak
  const qFontPx = Math.round(pxH * 0.04);   // question font size
  const optFontPx = Math.round(pxH * 0.035); // options font size (slightly smaller)
  ctx.font = `${qFontPx}px Kalam`;
  ctx.textBaseline = "top";

  // compute x start
  const xStart = Math.round(pxW * 0.03); // left padding 3%
  let y = topMarginPx;

  // draw question (multi-line support)
  const qLines = (item.question||"").split('\n');
  for(const line of qLines){
    ctx.font = `${qFontPx}px Kalam`;
    wrapText(ctx, line, xStart, y, pxW - xStart*2, qFontPx + 2);
    y += (qFontPx + 2);
  }

  // draw options with ZERO extra gap: we put immediately next lines
  const opts = item.option.slice(0,4);
  for(let i=0;i<opts.length;i++){
    const line = `${i+1}. ${opts[i] || ""}`;
    ctx.font = `${optFontPx}px Kalam`;
    wrapText(ctx, line, xStart, y, pxW - xStart*2, optFontPx + 2);
    y += (optFontPx + 2); // minimal increment
  }

  return cvs.toDataURL('image/png');
}

/* simple wrapText for canvas */
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(' ');
  let line = '';
  for(let n=0;n<words.length;n++){
    const testLine = line + words[n] + ' ';
    const metrics = ctx.measureText(testLine);
    if(metrics.width > maxWidth && n>0){
      ctx.fillText(line.trim(), x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  if(line) ctx.fillText(line.trim(), x, y);
}

/* Generate PPTX */
$('generateBtn').addEventListener('click', async ()=>{
  if(DATA.length===0){ alert('No questions to export'); return; }

  // sync preview edits
  syncPreviewToData();

  const pxW = parseInt($('slideW').value) || 1280;
  const pxH = parseInt($('slideH').value) || 720;
  const topMarginPx = parseInt($('topMargin').value) || 10;

  // Prepare PPTX
  const pptx = new PptxGenJS();

  // define custom layout (in inches)
  const wIn = pxToIn(pxW);
  const hIn = pxToIn(pxH);
  try{
    // defineLayout is supported
    pptx.defineLayout({ name:'CUSTOM', width: wIn, height: hIn });
    pptx.layout = 'CUSTOM';
  }catch(e){
    // fallback: try setting slide size via pptx.presLayout? ignore if fails
    console.warn('defineLayout failed', e);
  }

  // For each item create canvas image and add as full-size image
  for(let i=0;i<DATA.length;i++){
    const item = DATA[i];
    const dataUrl = await renderSlideToDataURL(item, pxW, pxH, topMarginPx, BG_DATAURL);

    const slide = pptx.addSlide();
    // add image covering full slide
    slide.addImage({ data: dataUrl, x:0, y:0, w: wIn, h: hIn });
  }

  // write file
  await pptx.writeFile({ fileName: 'MCQ_Canvas_Kalam.pptx' });
});

/* initial */
renderPreview();
</script>
</body>
</html>
