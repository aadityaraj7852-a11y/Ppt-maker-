<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>MCQ → PPTX (Perfect Line Break + Columns + Margins + Kalam)</title>

<link href="https://fonts.googleapis.com/css2?family=Kalam&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.bundle.min.js"></script>

<style>
body{font-family:'Kalam',cursive;background:#0f1720;color:#eee;margin:16px}
.card{background:#121926;padding:16px;border-radius:10px;border:1px solid #223;max-width:1150px;margin:auto}
label{color:#9fb7ff;font-weight:700;margin-top:8px;display:block}
textarea,input{width:100%;padding:8px;border-radius:6px;border:1px solid #334;background:#0b1220;color:#fff;font-family:'Kalam',cursive}
.btn{padding:8px 12px;border:none;border-radius:8px;margin-top:10px;cursor:pointer;font-family:'Kalam',cursive;font-weight:700}
.btn-blue{background:#0b74ff;color:#fff}
.btn-grey{background:#333;color:#ccd}
.btn-red{background:#e11d48;color:#fff}

.preview{background:#071019;border:1px solid #203040;margin-top:10px;
         border-radius:8px;padding:12px;max-height:520px;overflow:auto}
.slide-box{background:#000;color:#fff;padding:8px;border-radius:6px;margin-bottom:10px}
.slide-block{white-space:pre-line;font-size:18px;line-height:1.05}
.slide-block[contenteditable="true"]{outline:1px dashed #666;padding:6px;border-radius:4px}

.row{display:flex;gap:14px;flex-wrap:wrap}
.col{flex:1;min-width:300px}
</style>
</head>

<body>
<div class="card">

<h2 style="color:#fff">MCQ → PPTX (Line Break FIX + Margins + Columns + Kalam)</h2>

<div class="row">

<!-- LEFT -->
<div class="col">

<label>JSON Input</label>
<textarea id="jsonData" rows="8"></textarea>

<h3 style="color:#fff;margin-top:10px">Manual Entry</h3>

<label>Question</label>
<textarea id="qInput" rows="2"></textarea>

<label>Options</label>
<input id="o1" placeholder="Option 1">
<input id="o2" placeholder="Option 2">
<input id="o3" placeholder="Option 3">
<input id="o4" placeholder="Option 4">

<button class="btn btn-grey" id="addBtn">Add Question</button>

<label style="margin-top:10px">Background Image</label>
<input type="file" id="bgImg" accept="image/*">

<div class="row">
  <div class="col"><label>Slide Width (px)</label><input id="wPx" value="1280"></div>
  <div class="col"><label>Slide Height (px)</label><input id="hPx" value="720"></div>
</div>

<div class="row">
  <div class="col"><label>Top Margin</label><input id="topM" value="130"></div>
  <div class="col"><label>Left Margin</label><input id="leftM" value="50"></div>
</div>

<div class="row">
  <div class="col"><label>Right Margin</label><input id="rightM" value="50"></div>
  <div class="col"><label>Bottom Margin</label><input id="bottomM" value="100"></div>
</div>

<div class="row">
  <div class="col"><label>Question Color</label><input type="color" id="qColor" value="#ffff00"></div>
  <div class="col"><label>Option Color</label><input type="color" id="oColor" value="#ffffff"></div>
</div>

<button id="importBtn" class="btn btn-grey">Import JSON</button>
<button id="makeBtn" class="btn btn-blue">Generate PPTX</button>
<button id="clrBtn" class="btn btn-red">Clear</button>

</div>

<!-- RIGHT -->
<div class="col">
<label>Preview (editable)</label>
<div id="preview" class="preview"><div style="color:#7aa">Preview दिखाई देगा…</div></div>
</div>

</div>
</div>


<script>

const $ = id => document.getElementById(id);
let DATA = [];
let BG = null;

/* ---------------- FIXED NORMALIZER (No trim, keep all newlines) ---------------- */
function normalize(item){
 return {
   question:(item.question||"")
       .replace(/\\n/g,"\n")
       .replace(/\/n/g,"\n"),
   option:(item.option||["","","",""])
       .slice(0,4)
       .map(o=>o.replace(/\\n/g,"\n").replace(/\/n/g,"\n"))
 };
}

/* ------------- FIXED PARSE BLOCK — NO TRIM, NO LOSS OF NEWLINES ------------- */
function parseBlock(t){
 let lines = t.split("\n");   // keep ALL lines exactly as typed

 let q = lines[0].replace(/^[Qq]\d+\.\s*/, "");

 let opts = [];
 for(let i=1;i<lines.length && opts.length<4;i++){
   opts.push(lines[i].replace(/^\d+\.\s*/,""));
 }
 while(opts.length<4) opts.push("");

 return normalize({question:q, option:opts});
}

/* ---------------- Preview Renderer ---------------- */
function render(){
 let box=$("preview");
 box.innerHTML="";
 if(!DATA.length){
   box.innerHTML="<div style='color:#7aa'>No questions.</div>";
   return;
 }
 DATA.forEach((q,i)=>{
   let wrap=document.createElement("div");
   wrap.className="slide-box";

   let blk=document.createElement("div");
   blk.className="slide-block";
   blk.contentEditable="true";

   blk.innerText =
     `Q${i+1}. ${q.question}\n`+
     `1. ${q.option[0]}\n`+
     `2. ${q.option[1]}\n`+
     `3. ${q.option[2]}\n`+
     `4. ${q.option[3]}`;

   blk.addEventListener("blur",()=>{
     DATA[i] = parseBlock(blk.innerText);
     render();
   });

   wrap.appendChild(blk);
   box.appendChild(wrap);
 });
}

/* ---------------- JSON Input ---------------- */
$("importBtn").onclick=()=>{
 try{
   let j=JSON.parse($("jsonData").value);
   if(!Array.isArray(j)) j=[j];
   DATA=j.map(normalize);
   render();
 }catch(err){alert("JSON Error");}
};

/* ---------------- Add manually ---------------- */
$("addBtn").onclick=()=>{
 if(!$("qInput").value.trim()) return alert("Empty question");

 DATA.push(normalize({
   question:$("qInput").value,
   option:[$("o1").value,$("o2").value,$("o3").value,$("o4").value]
 }));

 $("qInput").value=$("o1").value=$("o2").value=$("o3").value=$("o4").value="";
 render();
};

/* ---------------- Background upload ---------------- */
$("bgImg").onchange=async e=>{
 let f=e.target.files[0];
 if(!f) return;
 let r=new FileReader();
 r.onload=()=>BG=r.result;
 r.readAsDataURL(f);
};

/* ---------------- Sync preview ---------------- */
function syncPreview(){
 document.querySelectorAll(".slide-block").forEach((blk,i)=>{
   DATA[i]=parseBlock(blk.innerText);
 });
}

/* Canvas wrap */
function wrapText(ctx,txt,x,y,maxW,lh,bottom){
 let words=txt.split(" ");
 let line="";
 for(let w of words){
   let t=line+w+" ";
   if(ctx.measureText(t).width>maxW){
     ctx.fillText(line,x,y);
     y+=lh;
     if(y>=bottom) return bottom;
     line=w+" ";
   } else line=t;
 }
 ctx.fillText(line,x,y);
 y+=lh;
 return y;
}

/* Detect 2-column */
function detectTwoCol(text){
 let rows=text.split("\n");
 return rows.some(r=>/^A\./.test(r)) && rows.some(r=>/^1\./.test(r));
}

/* ---------------- Canvas slide renderer (FINAL FIX) ---------------- */
async function canvasSlide(item,index,W,H,top,left,right,bottom,qc,oc){
 await document.fonts.load("30px Kalam");

 let c=document.createElement("canvas");
 c.width=W; c.height=H;
 let ctx=c.getContext("2d");

 if(BG){
   let im=new Image(); im.src=BG;
   await new Promise(r=>im.onload=r);
   ctx.drawImage(im,0,0,W,H);
 } else {
   ctx.fillStyle="#000";
   ctx.fillRect(0,0,W,H);
 }

 let qF=Math.round(H*0.045);
 let oF=Math.round(H*0.038);

 let maxW=W-left-right;
 let y=top;
 let limit=H-bottom;

 let Q=`Q${index+1}. ${item.question}`;

 let isTwo=detectTwoCol(Q);

 /* ------- COLUMN MODE -------- */
 if(isTwo){
   ctx.font=`bold ${qF}px Kalam`;
   ctx.fillStyle=qc;

   let lines=Q.split("\n");
   let col1=[],col2=[];
   lines.forEach(r=>{
     if(/^A\.|^B\.|^C\.|^D\./.test(r)) col1.push(r);
     else if(/^1\.|^2\.|^3\.|^4\./.test(r)) col2.push(r);
     else col1.push(r);
   });

   let gap=280;

   /* Col1 */
   for(let ln of col1){
     if(ln.trim()===""){y+=qF+2;continue;}
     y=wrapText(ctx,ln,left,y,maxW,qF+3,limit);
   }

   /* Col2 */
   let y2=top;
   ctx.font=`bold ${qF}px Kalam`;
   for(let ln of col2){
     if(ln.trim()===""){y2+=qF+2;continue;}
     y2=wrapText(ctx,ln,left+gap,y2,maxW-gap,qF+3,limit);
   }

 } else {

   /* ------- NORMAL MODE -------- */
   ctx.font=`bold ${qF}px Kalam`;
   ctx.fillStyle=qc;

   for(let ln of Q.split("\n")){
     if(ln.trim()===""){y+=qF+2;continue;}
     y=wrapText(ctx,ln,left,y,maxW,qF+3,limit);
   }
 }

 /* OPTIONS */
 ctx.font=`${oF}px Kalam`;
 ctx.fillStyle=oc;

 for(let i=0;i<4;i++){
   let ln=`${i+1}. ${item.option[i]}`;
   y=wrapText(ctx,ln,left,y,maxW,oF+2,limit);
 }

 return c.toDataURL("image/png");
}

function pxIn(px){return px/96;}

/* ---------------- Generate PPT ---------------- */
$("makeBtn").onclick=async()=>{

 if(!DATA.length) return alert("No questions!");

 syncPreview();

 let W=parseInt($("wPx").value);
 let H=parseInt($("hPx").value);
 let top=parseInt($("topM").value);
 let left=parseInt($("leftM").value);
 let right=parseInt($("rightM").value);
 let bottom=parseInt($("bottomM").value);

 let qc=$("qColor").value;
 let oc=$("oColor").value;

 let ppt=new PptxGenJS();
 ppt.defineLayout({name:"CUST",width:pxIn(W),height:pxIn(H)});
 ppt.layout="CUST";

 for(let i=0;i<DATA.length;i++){
   let img = await canvasSlide(DATA[i],i,W,H,top,left,right,bottom,qc,oc);
   let slide=ppt.addSlide();
   slide.addImage({data:img,x:0,y:0,w:pxIn(W),h:pxIn(H)});
 }

 ppt.writeFile({fileName:"MCQ_Final_FIXED.pptx"});
};

/* ---------------- Clear ---------------- */
$("clrBtn").onclick=()=>{DATA=[];$("jsonData").value="";render();};

render();
</script>

</body>
</html>
